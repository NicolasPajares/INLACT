<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>INLACT</title>

    <!-- SEO / Mobile -->
    <meta name="description" content="INLACT - Registro de visitas y clientes">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- CSS principal -->
    <link rel="stylesheet" href="index.css">

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
</head>

<body>

<header>
    <figure>
        <img src="img/logo.jpg" alt="INLACT">
    </figure>
    <h2>NICOL√ÅS PAJARES</h2>
</header>

<main>

<!-- ACCESOS R√ÅPIDOS -->
<section class="quick-actions">
    <a href="clientes.html" class="action-card">
        <img src="img/icon-clientes.svg">
        <span>Clientes</span>
    </a>
    <a href="stock.html" class="action-card">
        <img src="img/icon-stock.svg">
        <span>Stock</span>
    </a>
    <a href="ensayos.html" class="action-card">
        <img src="img/icon-ensayos.svg">
        <span>Ensayos</span>
    </a>
    <a href="precios.html" class="action-card">
        <img src="img/icon-precios.svg">
        <span>Precios</span>
    </a>
</section>

<!-- MAPA -->
<section class="card">
    <h2>Mapa de clientes</h2>
    <div id="map"></div>
</section>

<!-- VISITAS CERCANAS -->
<section class="card">
    <h2>Visitas cercanas</h2>
    <p id="estado">Buscando f√°bricas...</p>
    <div id="acciones" class="lista-clientes"></div>
</section>

<!-- √öLTIMAS VISITAS -->
<section class="card">
    <h3>√öltimas visitas</h3>
    <ul id="listaVisitas"></ul>
    <a href="#" id="abrir-historial">Ver historial completo ‚Üí</a>
</section>

</main>

<footer>
    <p>¬© INLACT ¬∑ <a href="aviso-legal.html">Aviso Legal</a></p>
</footer>

<!-- Leaflet -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- App principal -->
<script type="module" src="app.js"></script>

<!-- üî• √öLTIMAS VISITAS CON COLORES -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  getDocs,
  query,
  orderBy,
  limit
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCpCO82XE8I990mWw4Fe8EVwmUOAeLZdv4",
  authDomain: "inlact.firebaseapp.com",
  projectId: "inlact",
  storageBucket: "inlact.appspot.com",
  messagingSenderId: "143868382036",
  appId: "1:143868382036:web:b5af0e4faced7e880216c1"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const lista = document.getElementById("listaVisitas");

async function cargarUltimasVisitas() {
  lista.innerHTML = "<li>Cargando...</li>";

  const q = query(
    collection(db, "visitas"),
    orderBy("fecha", "desc"),
    limit(5)
  );

  const snap = await getDocs(q);
  lista.innerHTML = "";

  if (snap.empty) {
    lista.innerHTML = "<li>No hay visitas</li>";
    return;
  }

  snap.forEach(doc => {
    const v = doc.data();
    const fecha = v.fecha?.toDate
      ? v.fecha.toDate().toLocaleString("es-AR")
      : "";

    let clase = "tag-visita";
    if (v.tipoVisita === "Entrega de productos") clase += " tag-entrega";
    else if (v.tipoVisita === "Visita comercial") clase += " tag-comercial";
    else if (v.tipoVisita === "Ensayo") clase += " tag-ensayo";

    let productosHTML = "";
    if (v.productos && v.productos.length) {
      productosHTML = v.productos
        .map(p => `üì¶ ${p.nombre} (${p.cantidad})`)
        .join("<br>");
    }

    const li = document.createElement("li");
    li.innerHTML = `
      <strong>${v.cliente}</strong><br>
      <small>${fecha}</small><br>
      <span class="${clase}">${v.tipoVisita || "Sin tipo"}</span>
      ${productosHTML ? `<div class="productos">${productosHTML}</div>` : ""}
    `;

    lista.appendChild(li);
  });
}

cargarUltimasVisitas();

document.getElementById("abrir-historial").onclick = e => {
  e.preventDefault();
  window.open("historial.html", "historial", "width=420,height=700");
};
</script>

</body>
</html>
